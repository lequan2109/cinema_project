{% extends 'cinema_app/base.html' %}
{% block title %}Đặt vé - {{ showtime.movie.title }}{% endblock %}

{% block content %}
<div class="container">
    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'home' %}" class="text-decoration-none">Trang chủ</a></li>
            <li class="breadcrumb-item"><a href="{% url 'movie_detail' showtime.movie.id %}" class="text-decoration-none">{{ showtime.movie.title }}</a></li>
            <li class="breadcrumb-item active">Đặt vé</li>
        </ol>
    </nav>

    <div class="row g-4">
        <!-- Phần sơ đồ ghế -->
        <div class="col-lg-8">
            <div class="card border-0 shadow-sm h-100">
                <div class="card-header bg-white py-3 border-bottom">
                    <h5 class="mb-0 fw-bold text-primary">
                        <i class="fas fa-couch me-2"></i>Sơ đồ ghế: {{ room.name }}
                    </h5>
                </div>
                
                <div class="card-body bg-light">
                    <!-- Màn hình -->
                    <div class="screen-container mb-5 text-center">
                        <div class="screen bg-dark text-white py-2 shadow mx-auto rounded-bottom" style="width: 80%; max-width: 600px;">
                            <small class="text-uppercase letter-spacing-2">Màn hình</small>
                        </div>
                        <div class="screen-shadow mx-auto mt-1" style="width: 70%; height: 20px; background: radial-gradient(ellipse at center, rgba(0,0,0,0.2) 0%, rgba(0,0,0,0) 70%);"></div>
                    </div>
                    
                    <!-- Sơ đồ ghế -->
                    <div class="seat-map-wrapper text-center pb-4" style="overflow-x: auto;">
                        <div class="d-inline-block px-3">
                            {% for row_data in grid %}
                            <div class="d-flex justify-content-center align-items-center mb-2 gap-1 flex-nowrap">
                                <div class="row-label fw-bold text-muted me-3" style="width: 30px;">
                                    {{ row_data.row_label }}
                                </div>
                                
                                {% for seat in row_data.seats %}
                                    {% if seat.status == 'taken' %}
                                        <button class="btn btn-secondary btn-sm seat-btn disabled" disabled style="opacity: 0.5;">
                                            <span class="seat-text">{{ seat.label|slice:"1:" }}</span>
                                        </button>
                                    {% elif seat.status == 'locked' %}
                                        <button class="btn btn-secondary btn-sm seat-btn disabled" disabled style="background-color: #6c757d;">
                                            <i class="fas fa-lock fa-xs"></i>
                                        </button>
                                    {% elif seat.status == 'selected' %}
                                        <button class="btn btn-primary btn-sm seat-btn selected" data-seat="{{ seat.label }}">
                                            <span class="seat-text">{{ seat.label|slice:"1:" }}</span>
                                        </button>
                                    {% else %}
                                        <button class="btn btn-outline-primary btn-sm seat-btn" data-seat="{{ seat.label }}" onclick="toggleSeat(this)">
                                            <span class="seat-text">{{ seat.label|slice:"1:" }}</span>
                                        </button>
                                    {% endif %}
                                {% endfor %}
                            </div>
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Chú thích -->
                    <div class="d-flex justify-content-center gap-3 mt-4 small text-muted flex-wrap">
                        <div class="d-flex align-items-center">
                            <div class="seat-sample border border-primary bg-white rounded me-2" style="width: 20px; height: 20px;"></div> 
                            <span>Trống</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-sample bg-primary rounded me-2" style="width: 20px; height: 20px;"></div> 
                            <span>Đang chọn</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-sample bg-secondary opacity-50 rounded me-2" style="width: 20px; height: 20px;"></div> 
                            <span>Đã bán</span>
                        </div>
                        <div class="d-flex align-items-center">
                            <div class="seat-sample bg-secondary rounded me-2 d-flex align-items-center justify-content-center text-white" style="width: 20px; height: 20px;">
                                <i class="fas fa-lock fa-xs"></i>
                            </div> 
                            <span>Giữ chỗ</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Phần thông tin đặt vé -->
        <div class="col-lg-4">
            <div class="booking-sidebar sticky-lg-top" style="top: 20px; z-index: 10;">
                <!-- Thông tin phim -->
                <div class="card border-0 shadow-sm mb-3 overflow-hidden">
                    <div class="row g-0">
                        <div class="col-4">
                            {% if showtime.movie.poster %}
                            <img src="{{ showtime.movie.poster.url }}" class="img-fluid h-100" style="object-fit: cover;" alt="Poster">
                            {% endif %}
                        </div>
                        <div class="col-8">
                            <div class="card-body p-3">
                                <h6 class="card-title fw-bold mb-1">{{ showtime.movie.title }}</h6>
                                <p class="card-text small text-muted mb-2">{{ showtime.movie.genre }}</p>
                                <div class="d-flex align-items-center small text-secondary mb-1">
                                    <i class="fas fa-clock me-2"></i> {{ showtime.movie.duration }} phút
                                </div>
                                <div class="d-flex align-items-center small text-secondary">
                                    <i class="fas fa-user-shield me-2"></i> {{ showtime.movie.age_limit }}+
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Thông tin đặt vé -->
                <div class="card border-0 shadow-lg border-top border-4 border-primary">
                    <div class="card-body p-4">
                        <h5 class="fw-bold mb-3 text-uppercase text-center text-primary">Thông tin đặt vé</h5>
                        
                        <div class="mb-3 pb-3 border-bottom">
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted"><i class="fas fa-calendar-day me-2"></i>Ngày chiếu:</span>
                                <span class="fw-bold">{{ showtime.start_time|date:'d/m/Y' }}</span>
                            </div>
                            <div class="d-flex justify-content-between mb-1">
                                <span class="text-muted"><i class="fas fa-clock me-2"></i>Giờ chiếu:</span>
                                <span class="fw-bold">{{ showtime.start_time|date:'H:i' }}</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span class="text-muted"><i class="fas fa-door-open me-2"></i>Rạp:</span>
                                <span class="fw-bold">{{ room.name }}</span>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="text-muted small mb-1">Ghế đang chọn:</label>
                            <div id="selected-seats-display" class="fw-bold text-break text-primary fs-5">Chưa chọn</div>
                        </div>

                        <div class="d-flex justify-content-between align-items-center mb-4 bg-light p-2 rounded">
                            <span class="fw-bold">Tạm tính:</span>
                            <span id="total-price-display" class="fw-bold text-danger fs-4">0 đ</span>
                        </div>

                        <form method="post" id="booking-form">
                            {% csrf_token %}
                            <input type="hidden" name="seats" id="id_seats">
                            
                            <div class="input-group mb-3">
                                <span class="input-group-text bg-white border-end-0"><i class="fas fa-tag text-muted"></i></span>
                                <input type="text" name="promo_code" id="promo-input" class="form-control border-start-0 ps-0" placeholder="Mã giảm giá" readonly>
                                <button class="btn btn-outline-secondary" type="button" data-bs-toggle="modal" data-bs-target="#promoModal">Chọn</button>
                            </div>
                            <div class="d-flex justify-content-between small text-success mb-3" id="promo-text"></div>

                            <button type="submit" class="btn btn-danger w-100 py-3 fw-bold text-uppercase shadow-sm" id="submit-btn" disabled>
                                Thanh toán ngay <i class="fas fa-arrow-right ms-2"></i>
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Thông báo trạng thái -->
                <div id="api-loading" class="alert alert-info mt-3 small text-center" style="display: none;">
                    <span class="spinner-border spinner-border-sm me-2"></span>Đang xử lý giữ ghế...
                </div>
                <div id="api-error" class="alert alert-danger mt-3 small text-center shadow-sm" style="display: none;"></div>
            </div>
        </div>
    </div>
</div>

<!-- Modal chọn voucher -->
<div class="modal fade" id="promoModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Chọn Voucher</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0">
                <div class="list-group list-group-flush">
                    {% for promo in promotions %}
                        {% if promo.is_active and promo.valid_until >= today %}
                            <button type="button" class="list-group-item list-group-item-action promo-select-btn p-3"
                                    data-code="{{ promo.code }}" data-percent="{{ promo.discount_percent }}">
                                <div class="d-flex w-100 justify-content-between align-items-center">
                                    <div>
                                        <h6 class="mb-1 fw-bold text-primary">{{ promo.code }}</h6>
                                        <small class="text-muted">Giảm {{ promo.discount_percent }}% - Hạn: {{ promo.valid_until|date:"d/m/Y" }}</small>
                                    </div>
                                    <i class="fas fa-chevron-right text-muted"></i>
                                </div>
                            </button>
                        {% endif %}
                    {% empty %}
                        <div class="p-4 text-center text-muted">Không có mã giảm giá nào.</div>
                    {% endfor %}
                </div>
            </div>
            <div class="modal-footer bg-light">
                <button type="button" class="btn btn-outline-danger w-100 promo-select-btn" data-code="" data-percent="0">Hủy dùng mã</button>
            </div>
        </div>
    </div>
</div>

{{ showtime.base_price|json_script:"js-base-price" }}
{{ showtime.id|json_script:"js-showtime-id" }}

<style>
    .seat-btn {
        width: 38px; 
        height: 38px; 
        padding: 0; 
        display: flex; 
        align-items: center; 
        justify-content: center;
        border-radius: 8px;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    
    .seat-btn:hover:not(.disabled) {
        transform: scale(1.05);
    }
    
    .seat-text { 
        font-size: 0.75rem; 
        font-weight: 600; 
    }
    
    /* Thanh cuộn đẹp */
    .seat-map-wrapper::-webkit-scrollbar { 
        height: 8px; 
    }
    
    .seat-map-wrapper::-webkit-scrollbar-track { 
        background: #f1f1f1; 
        border-radius: 4px; 
    }
    
    .seat-map-wrapper::-webkit-scrollbar-thumb { 
        background: #ccc; 
        border-radius: 4px; 
    }
    
    .seat-map-wrapper::-webkit-scrollbar-thumb:hover { 
        background: #bbb; 
    }

    /* Nút Loading */
    .seat-btn.loading { 
        cursor: wait; 
        opacity: 0.7; 
    }
    
    /* Hiệu ứng cho màn hình */
    .screen {
        background: linear-gradient(to bottom, #343a40, #495057);
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }
    
    /* Hiệu ứng cho sidebar */
    .booking-sidebar .card {
        transition: transform 0.2s;
    }
    
    .booking-sidebar .card:hover {
        transform: translateY(-2px);
    }
    
    /* Hiệu ứng cho các nút chọn ghế */
    @keyframes pulse {
        0% { transform: scale(1); }
        50% { transform: scale(1.05); }
        100% { transform: scale(1); }
    }
    
    .seat-btn.selected {
        animation: pulse 1.5s infinite;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const seatInput = document.getElementById('id_seats');
    const displaySeats = document.getElementById('selected-seats-display');
    const displayPrice = document.getElementById('total-price-display');
    const submitBtn = document.getElementById('submit-btn');
    const loadingEl = document.getElementById('api-loading');
    const errorEl = document.getElementById('api-error');
    const promoInput = document.getElementById('promo-input');
    const promoText = document.getElementById('promo-text');
    const promoModal = bootstrap.Modal.getOrCreateInstance(document.getElementById('promoModal'));

    const basePrice = JSON.parse(document.getElementById('js-base-price').textContent);
    const showtimeId = JSON.parse(document.getElementById('js-showtime-id').textContent);
    
    // Hàm lấy CSRF Token an toàn
    function getCookie(name) {
        let cookieValue = null;
        if (document.cookie && document.cookie !== '') {
            const cookies = document.cookie.split(';');
            for (let i = 0; i < cookies.length; i++) {
                const cookie = cookies[i].trim();
                if (cookie.substring(0, name.length + 1) === (name + '=')) {
                    cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                    break;
                }
            }
        }
        return cookieValue;
    }
    const csrfToken = getCookie('csrftoken');

    let selectedSeats = [];
    let currentDiscount = 0;
    let isProcessing = false;

    // Format tiền Việt
    const formatter = new Intl.NumberFormat('vi-VN', { style: 'currency', currency: 'VND' });

    function updateUI() {
        if (selectedSeats.length === 0) {
            displaySeats.textContent = 'Chưa chọn';
            displayPrice.textContent = '0 đ';
            seatInput.value = '';
            submitBtn.disabled = true;
            submitBtn.innerHTML = 'Thanh toán ngay <i class="fas fa-arrow-right ms-2"></i>';
        } else {
            // Sắp xếp ghế A1, A2, B1...
            selectedSeats.sort();
            displaySeats.textContent = selectedSeats.join(', ');
            
            const subtotal = selectedSeats.length * basePrice;
            const discountAmount = subtotal * (currentDiscount / 100);
            const total = subtotal - discountAmount;
            
            displayPrice.textContent = formatter.format(total);
            seatInput.value = selectedSeats.join(',');
            submitBtn.disabled = false;
            submitBtn.innerHTML = `Thanh toán ${formatter.format(total)} <i class="fas fa-arrow-right ms-2"></i>`;
        }
    }

    // Hàm Toggle Ghế
    window.toggleSeat = async function(btn) {
        if (isProcessing) return;
        const seatLabel = btn.dataset.seat;
        const isSelected = btn.classList.contains('selected');
        const url = isSelected ? "{% url 'api_release_seat' %}" : "{% url 'api_lock_seat' %}";

        // UI Feedback ngay lập tức
        isProcessing = true;
        btn.classList.add('loading');
        errorEl.style.display = 'none';
        loadingEl.style.display = 'block';

        try {
            const res = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({ showtime_id: showtimeId, seat_label: seatLabel })
            });
            const data = await res.json();

            loadingEl.style.display = 'none';
            btn.classList.remove('loading');

            if (data.status === 'success') {
                if (isSelected) {
                    btn.classList.remove('selected', 'btn-primary');
                    btn.classList.add('btn-outline-primary');
                    selectedSeats = selectedSeats.filter(s => s !== seatLabel);
                } else {
                    btn.classList.remove('btn-outline-primary');
                    btn.classList.add('selected', 'btn-primary');
                    selectedSeats.push(seatLabel);
                }
                updateUI();
            } else {
                // Lỗi (ví dụ ghế đã bị người khác chọn)
                errorEl.textContent = data.message;
                errorEl.style.display = 'block';
                if (!isSelected) { // Nếu đang cố chọn mà lỗi -> Disable luôn
                    btn.classList.add('disabled', 'btn-secondary');
                    btn.disabled = true;
                }
            }
        } catch (err) {
            console.error(err);
            errorEl.textContent = "Lỗi kết nối server!";
            errorEl.style.display = 'block';
            loadingEl.style.display = 'none';
            btn.classList.remove('loading');
        }
        isProcessing = false;
    };

    // Xử lý chọn Voucher
    document.querySelectorAll('.promo-select-btn').forEach(btn => {
        btn.addEventListener('click', () => {
            const code = btn.dataset.code;
            const percent = parseInt(btn.dataset.percent);
            
            currentDiscount = percent;
            promoInput.value = code;
            
            if (percent > 0) {
                promoText.innerHTML = `<i class="fas fa-check-circle me-1"></i>Đã áp dụng mã: Giảm ${percent}%`;
            } else {
                promoText.textContent = '';
            }
            
            updateUI();
            promoModal.hide();
        });
    });

    // Khôi phục trạng thái ghế ban đầu (Server render)
    document.querySelectorAll('.seat-btn.selected').forEach(btn => {
        selectedSeats.push(btn.dataset.seat);
    });
    updateUI();

    // Nhả ghế khi rời trang
    window.addEventListener('beforeunload', () => {
        if (selectedSeats.length > 0) {
            selectedSeats.forEach(seat => {
                fetch("{% url 'api_release_seat' %}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json', 'X-CSRFToken': csrfToken},
                    body: JSON.stringify({ showtime_id: showtimeId, seat_label: seat }),
                    keepalive: true
                });
            });
        }
    });
});
</script>
{% endblock %}